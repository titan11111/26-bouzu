<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>僧侶の相談ゲーム</title>
<style>
body {font-family: 'Sawarabi Mincho', 'Yu Mincho', serif;background: #f5f5dc;margin:0;padding:20px;}
.status{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;}
.status-item{background:#fff;padding:5px 10px;border:1px solid #ccc;border-radius:4px;}
.advice-buttons{display:flex;flex-direction:column;gap:5px;margin-top:10px;}
.result{margin-top:15px;padding:10px;border-radius:4px;white-space:pre-line;}
.result.success{background:#e0ffe0;}
.result.failure{background:#ffe0e0;}
</style>
</head>
<body>
<h1>僧侶の相談ゲーム</h1>
<div class="status">
  <div class="status-item">感謝:<span id="score">0</span></div>
  <div class="status-item">残り:<span id="remaining">0</span></div>
  <div class="status-item">コンボ:<span id="combo">0</span></div>
</div>
<div class="status">
  <div class="status-item">慈悲:<span id="stat-compassion">0</span></div>
  <div class="status-item">真理:<span id="stat-truth">0</span></div>
  <div class="status-item">無常観:<span id="stat-impermanence">0</span></div>
  <div class="status-item">求道心:<span id="stat-quest">0</span></div>
</div>

<div id="consultation-card">
  <div id="visitor-name"></div>
  <div id="consultation-text"></div>
</div>
<div id="advice-buttons" class="advice-buttons">
  <button onclick="selectAdvice(0)" id="advice1"></button>
  <button onclick="selectAdvice(1)" id="advice2"></button>
  <button onclick="selectAdvice(2)" id="advice3"></button>
</div>
<div id="result" class="result" style="display:none;">
  <div id="result-text"></div>
  <div id="result-message"></div>
  <div id="selected-advice"></div>
  <button onclick="nextConsultation()">次へ</button>
</div>

<script>
const MAX_LINE_LENGTH = 25;
function formatAdviceText(text){
  let t=text.trim();
  if(t.length>MAX_LINE_LENGTH*2){t=t.slice(0,MAX_LINE_LENGTH*2-1)+'…';}
  if(t.length>MAX_LINE_LENGTH){return t.slice(0,MAX_LINE_LENGTH)+"\n"+t.slice(MAX_LINE_LENGTH);}
  return t;
}

const consultations = [
 { name:"田中さん（会社員）", icon:"👨‍💼", traits:["真面目","ストレス"], problem:"仕事でのストレスが溜まり、毎日が辛く感じます。", preferredType:"共感",
   adviceOptions:[
     {text:"それは大変ですね。まず今夜ぐっすり眠ることを考えましょう",type:"共感",effects:{compassion:2},reaction:"「少し気持ちが楽になりました」",aftermath:"数日後、彼は休息を大切にするようになりました。"},
     {text:"問題の根本は何ですか？紙に書き出してみましょう",type:"解決",effects:{truth:2},reaction:"「整理してみます」",aftermath:"彼はノートに悩みを書き出し、解決策を見つけました。"},
     {text:"滝に打たれて魂を浄化しましょう",type:"奇抜",effects:{quest:1},reaction:"「えっ、滝ですか？」",aftermath:"滝行に挑戦したものの、風邪をひいてしまいました。"}
   ]},
 { name:"佐藤さん（主婦）", icon:"👩", traits:["家族思い","感情的"], problem:"家族との関係がうまくいかず、孤独を感じています。", preferredType:"解決",
   adviceOptions:[
     {text:"相手の気持ちを想像して手紙を書いてみましょう",type:"共感",effects:{compassion:2},reaction:"「手紙なら素直に書けそうです」",aftermath:"後日、家族と静かに話し合う時間が持てました。"},
     {text:"家庭のルールを紙に書いて話し合いましょう",type:"解決",effects:{truth:2},reaction:"「ルールを決めるのも大事ですね」",aftermath:"家族会議でお互いの気持ちを共有できたようです。"},
     {text:"滝に打たれて魂を浄化しましょう",type:"奇抜",effects:{quest:1},reaction:"「いや、滝はちょっと…」",aftermath:"特に変化はなかったようです。"}
   ]},
 { name:"鈴木さん（大学生）", icon:"👨‍🎓", traits:["恋愛至上主義"], problem:"失恋して立ち直れません。もう誰も愛せないと思います。", preferredType:"共感",
   adviceOptions:[
     {text:"時間が心の傷を癒してくれます。自分を大切にして、新しい出会いを信じてください",type:"共感",effects:{compassion:1,impermanence:1},reaction:"「少し希望が見えてきました」",aftermath:"ゆっくりと前を向けるようになったようです。"},
     {text:"元彼の家の前で歌を歌いましょう",type:"奇抜",effects:{quest:2},reaction:"「いや、それは恥ずかしいです…」",aftermath:"彼は歌わなかったが、代わりにカラオケで発散したそうです。"},
     {text:"問題の根本は何ですか？紙に書き出してみましょう",type:"解決",effects:{truth:1},reaction:"「感情を整理するのも大事ですね」",aftermath:"ノートに気持ちを書くことで心が整理できました。"}
   ]}
];
consultations.forEach(c=>c.adviceOptions.forEach(o=>{o.text=formatAdviceText(o.text);}));

let currentConsultation=0;
let score=0;
let remainingVisitors=consultations.length;
let combo=0;
let maxCombo=0;
let totalCorrect=0;
let totalIncorrect=0;
let playerStats={compassion:0,truth:0,impermanence:0,quest:0};

function initGame(){
  currentConsultation=0;
  score=0;
  remainingVisitors=consultations.length;
  combo=0;
  maxCombo=0;
  totalCorrect=0;
  totalIncorrect=0;
  playerStats={compassion:0,truth:0,impermanence:0,quest:0};
  updateDisplay();
  showConsultation();
}

function updateDisplay(){
  document.getElementById('score').textContent=score;
  document.getElementById('remaining').textContent=remainingVisitors;
  document.getElementById('combo').textContent=combo;
  document.getElementById('stat-compassion').textContent=playerStats.compassion;
  document.getElementById('stat-truth').textContent=playerStats.truth;
  document.getElementById('stat-impermanence').textContent=playerStats.impermanence;
  document.getElementById('stat-quest').textContent=playerStats.quest;
}

function showConsultation(){
  const c=consultations[currentConsultation];
  document.getElementById('visitor-name').textContent=c.name;
  document.getElementById('consultation-text').textContent=c.problem;
  const buttons=document.querySelectorAll('.advice-buttons button');
  c.adviceOptions.forEach((o,i)=>{
    buttons[i].textContent=o.text;
    buttons[i].style.display='block';
  });
  document.getElementById('result').style.display='none';
  document.getElementById('selected-advice').textContent='';
  document.getElementById('advice-buttons').style.display='flex';
}

function effectsToText(effects){
  const names={compassion:'慈悲',truth:'真理',impermanence:'無常観',quest:'求道心'};
  return Object.entries(effects).map(([k,v])=>names[k]+(v>=0?'+':'')+v).join(' ');
}

function applyEffects(effects){
  for(const [k,v] of Object.entries(effects)){playerStats[k]+=v;}
}

function selectAdvice(index){
  const c=consultations[currentConsultation];
  const option=c.adviceOptions[index];
  applyEffects(option.effects);
  const result=document.getElementById('result');
  const resultText=document.getElementById('result-text');
  const resultMessage=document.getElementById('result-message');
  const selected=document.getElementById('selected-advice');
  document.getElementById('advice-buttons').style.display='none';

  if(option.type===c.preferredType){
    totalCorrect++; combo++; if(combo>maxCombo)maxCombo=combo;
    score+=1; result.className='result success';
    resultText.textContent='✨ 良い導きです！ +1ポイント ✨';
  }else{
    totalIncorrect++; combo=0;
    result.className='result failure';
    resultText.textContent='😔 もう少し考えてみましょう... 😔';
  }
  resultMessage.textContent=option.reaction;
  selected.textContent='その後: '+option.aftermath+' ('+effectsToText(option.effects)+')';
  result.style.display='block';
  updateDisplay();
}

function nextConsultation(){
  currentConsultation++; remainingVisitors--;
  if(currentConsultation>=consultations.length){
    showGameOver();
  }else{
    document.getElementById('advice-buttons').style.display='flex';
    showConsultation();
  }
}

function showGameOver(){
  document.getElementById('consultation-card').style.display='none';
  document.getElementById('advice-buttons').style.display='none';
  document.getElementById('result').style.display='none';
  const accuracy=(totalCorrect/(totalCorrect+totalIncorrect))*100;
  document.body.innerHTML+=`<h2>ゲーム終了</h2><p>最終得点:${score}</p><p>正解率:${Math.round(accuracy)}%</p>`;
}

window.onload=initGame;
</script>
</body>
</html>
